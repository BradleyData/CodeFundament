version: '3.7'

x-docker-volume:
    &docker-volume
    - /var/run/docker.sock:/var/run/docker.sock:ro

services:
    traefik:
        image: traefik:v2.2.7
        command:
            - "--api.insecure=true"
            - "--entrypoints.web.address=:80"
            - "--log.level=WARN"
            - "--providers.docker=true"
            - "--providers.docker.defaultRule=Host(`${TRAEFIK_HOST}.${DOMAIN}`)"
            - "--providers.docker.swarmMode=false"
        networks:
            - traefik
        ports:
            - "80:80"
            - "8080:8080"
        restart: always
        volumes: *docker-volume
    api:
        build:
            context: ./containers/development/api
            target: dev
        networks:
            - traefik
        volumes:
            - ./volumes/api:/home/node/app
    info:
        build: ./containers/support/info
        networks:
            - traefik
        volumes:
            - ./volumes/api/output:/usr/local/apache2/htdocs/api
    patternlab:
        build:
            context: ./containers/development/patternlab
            target: dev
        labels:
            - traefik.http.routers.patternlab-${COMPOSE_PROJECT_NAME}.rule=Host(`patternlab.${DOMAIN}`)
            - traefik.http.routers.patternlab-${COMPOSE_PROJECT_NAME}.service=patternlab-${COMPOSE_PROJECT_NAME}
            - traefik.http.services.patternlab-${COMPOSE_PROJECT_NAME}.loadbalancer.server.port=3000
            - traefik.http.routers.browsersync-${COMPOSE_PROJECT_NAME}.rule=Host(`browsersync.${DOMAIN}`)
            - traefik.http.routers.browsersync-${COMPOSE_PROJECT_NAME}.service=browsersync-${COMPOSE_PROJECT_NAME}
            - traefik.http.services.browsersync-${COMPOSE_PROJECT_NAME}.loadbalancer.server.port=3001
        networks:
            - traefik
        volumes:
            - ./volumes/patternlab:/home/node/app
            - ../${ASSETS_PATH}/fonts:/home/node/app/source/fonts
            - ../${ASSETS_PATH}/icons:/home/node/app/source/icons
            - ../${ASSETS_PATH}/images:/home/node/app/source/images
networks:
    traefik:
